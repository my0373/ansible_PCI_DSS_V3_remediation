---
## So normally I would set this to
## - hosts: all
## However I only want to run this on this foreman group
- hosts:  foreman_hostgroup_rhel7
  remote_user: ansible
  gather_facts: no
  become: yes
  become_user: root
  become_method: sudo


  tasks:

  ## Ping all the effected servers. This is usefule for checking
  ## the scope of the machines it will be run against.
    - name: Update the kernel packages
      yum:
        name: 'kernel*'
        state: latest


    - name: Checking if we need a reboot
      # NOTE: this string check is wrong so always comes back as "yes"
      shell: if [ $(rpm -q kernel | sort -Vr | head -n 1) != kernel-$(uname -r) ]; then echo "yes"; fi
      register: reboot
      ignore_errors: true

    - name: restart server
      shell: sleep 2 && shutdown -r now
      async: 1
      poll: 0
      become: yes
      ignore_errors: true

    - name: waiting for server to come back after reboot
      local_action:
        wait_for host:  "{{ ansible_ssh_host }}"
        state:  started
        port: 22
        delay:  30
        timeout:  300
        connect_timeout:  15


